# H5 五子棋游戏规则与 AI 算法要点

> 版本：1.0  
> 用途：指导规则实现、禁手检测、AI 策略开发

---

## 1. 基础规则总览

### 1.1 棋盘
- 标准 15×15 网格，总计 225 个交叉点
- 天元坐标 (7,7)
- 坐标系统：列使用字母 A-O，行使用数字 1-15

### 1.2 落子规则
- 黑棋先手，双方轮流在空交叉点落子
- 落子后不可移动或移除（悔棋除外）
- 首步推荐在天元或附近（可添加提示）

### 1.3 胜负判定
- 任一方在任意方向（水平/垂直/主副对角）形成五子连线即获胜
- 棋盘填满且无五连时判定为平局
- 判定需返回连线坐标数组，用于高亮显示

---

## 2. 禁手规则详解（黑棋限定）

### 2.1 三三禁手（Double Three）
- 定义：一步落子同时形成两个或以上的“活三”
- 活三形态：
  - 连三：`_●●●_`
  - 跳三：`_●●_●_`、`_●_●●_`
- 检测要点：
  1. 临时落子后生成方向线性签名
  2. 匹配活三模式，统计数量
  3. 若 `活三总数 >= 2` 则判定为禁手

### 2.2 四四禁手（Double Four）
- 定义：一步落子同时形成两个或以上的“强四”
- 棋型分类：
  - 活四：`_●●●●_`
  - 冲四：`●●●●_`, `_●●●●`, `●●_●●`
- 检测要点：
  - 统计所有方向的活四与冲四
  - 若 `总数 >= 2` 则为禁手

### 2.3 长连禁手（Overline）
- 定义：落子后在任意方向形成六子或以上的连续棋子
- 注意：长连不视为胜利（黑棋禁止）
- 检测要点：
  - 统计方向上连续棋子数量
  - 若 `count >= 6` 则禁手

### 2.4 禁手检测返回格式
```json
{
  "isForbidden": true,
  "type": "三三禁手",
  "details": {
    "openThrees": { "total": 2, "directions": [...] },
    "openFours": { "total": 0 },
    "longLine": { "hasLongLine": false }
  }
}
```

### 2.5 视觉反馈建议
- 在 Canvas 上以红色圆圈/闪烁高亮标记
- HUD 显示 "⚠️ 三三禁手，黑棋不能在此位置落子"
- 保留 1.8 秒后自动消失，或用户点击后关闭

---

## 3. 棋型分析与评分体系

### 3.1 棋型分类
| 棋型 | 描述 | 评分建议 |
|------|------|----------|
| 五连 (FIVE) | 立即获胜 | 1,000,000 |
| 活四 (OPEN_FOUR) | 两端均可成五 | 160,000 |
| 冲四 (CLOSED_FOUR) | 一端阻塞 | 42,000 |
| 破四 (BROKEN_FOUR) | 中间空一格可成五 | 55,000 |
| 活三 (OPEN_THREE) | 两端可延伸成活四 | 12,000 |
| 眠三 (CLOSED_THREE) | 单端受阻的三连 | 2,600 |
| 破三 (BROKEN_THREE) | 中间空格的三连 | 6,200 |
| 活二 (OPEN_TWO) | 基础威胁种子 | 600 |
| 眠二 (CLOSED_TWO) | 受限二连 | 150 |

### 3.2 组合加分
- 双活四（Double Open Four）：420,000
- 双冲四（Double Broken Four）：200,000
- 活四 + 活三：120,000
- 双活三：36,000
- 活三 + 冲三：18,000

### 3.3 位置加权
- 鼓励在棋盘中心附近落子：
  - 得分 += `Math.max(0, 7 - |x-7| + 7 - |y-7|)`
- 移动排序依据：棋型得分 > 位置得分 > 随机扰动

---

## 4. 候选点生成策略

### 4.1 生成规则
1. 遍历棋盘所有空位
2. 统计在半径 2~3 范围内的邻居棋子数量
3. 过滤掉孤立点（邻居数量为 0）
4. 计算位置权重和模式潜力
5. 按优先级排序返回

```javascript
class CandidateGenerator {
  generate(state) {
    const candidates = [];
    const radius = 2;
    
    for (let y = 0; y < state.boardSize; y++) {
      for (let x = 0; x < state.boardSize; x++) {
        if (state.board[y][x] !== 0) continue;
        
        const neighbors = this.countNeighbors(state, x, y, radius);
        if (neighbors === 0) continue;
        
        const positional = this.calculatePositionalScore(x, y);
        candidates.push({ x, y, priority: neighbors + positional });
      }
    }
    
    return candidates.sort((a, b) => b.priority - a.priority);
  }
}
```

### 4.2 EvE 快速模式
- EvE 模式下可缩短 AI 思考间隔，为连续演示提供流畅体验
- 思考时间建议：Beginner 700ms、Normal 1100ms、Hard 1700ms、Hell 2400ms

---

## 5. AI 策略实现要点

### 5.1 Beginner（新手）
- 评分：只计算基本连子（2 连、3 连）
- 防守：50% 机率堵对方 4 连；40% 机率堵对方 3 连
- 进攻：倾向中心区域，随机性较高
- 落子流程：
  1. 检查是否有直接获胜点
  2. 检查是否需堵对方获胜点
  3. 否则随机从候选点中选取（适度权重）

### 5.2 Normal（正常）
- 使用 Minimax + Alpha-Beta（深度 2-3）
- 棋型评估考虑攻守平衡
- 棋型识别：活四、冲四、活三、眠三
- 防守优先级略高（避免玩家快速获胜）

### 5.3 Hard（困难）
- 增强搜索深度（3-4）
- 引入威胁序列（VCT/VCF）分析
- 启用开局库（前 10 步根据定式选择）
- 在每层搜索中优先尝试获胜与防守点

### 5.4 Hell（地狱）
- 搜索深度 4-5（根据性能调节）
- 引入威胁空间搜索（Threat Space Search）
- 使用证明数搜索（Proof-Number Search）验证确定胜负
- 可选：使用训练好的轻量神经网络辅助评估
- 需提供优化开关以避免影响页面性能

---

## 6. 回放与数据分析

### 6.1 回放元数据
- 每一步落子需要记录：
  - `step`：步数
  - `player`：1=黑,2=白
  - `x,y`：落子坐标
  - `timestamp`：毫秒级时间戳
  - `aiScore`：若为 AI 落子，记录评估分数
  - `forbiddenCheck`：若有禁手判定，记录详情

### 6.2 游戏结果信息
- `winner`：1/2/0
- `reason`：`five_in_row` / `draw` / `resigned`
- `winLine`：五连的坐标数组
- `duration`：对局时间（秒）

### 6.3 数据持久化策略
- 使用 `GameUtils.downloadAsJSON()` 导出棋谱
- 使用 `GameUtils.saveToLocalStorage()` 自动保存
- 加载时需检测版本并迁移

---

## 7. 调试与诊断工具

### 7.1 开发者模式（建议）
```javascript
window.GomokuDebug = {
  state: null,
  rules: null,
  ai: null,
  
  logState() {
    console.table(this.state.board);
  },
  
  logCandidates() {
    const candidates = this.ai.getLastCandidates();
    console.table(candidates.map(c => ({ ...c, notation: GameUtils.positionToNotation(c.x, c.y) })));
  },
  
  toggleForbiddenHighlight(enabled) {
    this.rules.setForbiddenHighlight(enabled);
  }
};
```

### 7.2 ModuleDependencyChecker 调用
```javascript
ModuleDependencyChecker.checkDependencies();
ModuleDependencyChecker.checkVersion({
  GameState: '2.0.0',
  RuleEngine: '2.0.0',
  CanvasRenderer: '2.0.0'
});
ModuleDependencyChecker.logModuleInfo();
```

---

## 8. 常见问题与优化建议

| 问题 | 解决方案 |
|------|-----------|
| 禁手检测性能不足 | 缩小检测范围、预计算线性签名、复用数组 |
| AI 计算过慢 | 限制候选点、增加剪枝、减少搜索深度、启用开局库 |
| 存档兼容性差 | 明确版本字段，读取时提供迁移逻辑 |
| UI 卡顿 | 使用 requestAnimationFrame、避免频繁 full redraw |
| 日志过多 | 提供 Logger 等级开关，生产环境禁用 debug |

---

## 9. 参考资料

- Victor Allis, "Searching for Solutions in Games and Artificial Intelligence" — 威胁空间搜索理论
- Gomoku AI 公开资料：Gomoku Renju Threat Space Search
- Web Canvas 性能优化指南（MDN）
- 旧项目文档：`docs/design/五子棋规则与算法.md`, `docs/design/AI难度等级设计.md`

---

> 本文档整合了旧项目的核心规则、禁手算法、AI 设计要点，并给出规范化实现建议，适合作为新的游戏引擎与 AI 系统实现的基础参考。