# H5 五子棋项目重新开发需求规格说明书

> 版本：1.0（2025-01-04）  
> 适用对象：重写版项目的产品、开发、测试、AI 设计、文档团队  
> 目标：在保留当前产品优势的前提下，彻底梳理核心需求，为全新代码基线提供高质量规范

---

## 目录

1. [项目概述](#项目概述)  
2. [业务背景与目标](#业务背景与目标)  
3. [用户画像与使用场景](#用户画像与使用场景)  
4. [术语定义](#术语定义)  
5. [功能需求](#功能需求)  
6. [游戏规则与算法要求](#游戏规则与算法要求)  
7. [AI 系统需求](#ai-系统需求)  
8. [系统架构与模块划分](#系统架构与模块划分)  
9. [数据与持久化需求](#数据与持久化需求)  
10. [界面与交互规范](#界面与交互规范)  
11. [非功能需求](#非功能需求)  
12. [日志、监控与可观测性](#日志监控与可观测性)  
13. [开发流程与质量保障](#开发流程与质量保障)  
14. [技术债务与改进建议](#技术债务与改进建议)  
15. [实施路线与任务拆解](#实施路线与任务拆解)  
16. [附录](#附录)

---

## 项目概述

- **产品名称**：H5 五子棋（Gomoku Web Game）
- **产品形态**：基于 HTML5 Canvas 的浏览器单页应用（静态站点）
- **当前版本**：v1.0.3（旧项目最新稳定版本）
- **部署方式**：纯前端静态资源，可部署至 GitHub Pages / 任意静态站点
- **访问设备**：桌面端、平板端、移动端（响应式布局）

## 业务背景与目标

| 项目历史 | 现状问题 | 重构目标 |
|-----------|-----------|-----------|
| 已实现完整对局流程、禁手规则、存档回放、四级 AI、机机对战等 | 代码体量超 8k 行，存在模块耦合、历史遗留注释、冗余日志、导出规范不统一、缺乏自动化测试 | 在保证体验的前提下重写核心代码，提升可维护性、可测试性、可扩展性；沉淀标准化文档体系，为后续更多玩法奠定基础 |

### 重构重点
1. 明确模块边界，拆分 UI、规则、AI、数据等核心职责  
2. 建立可追踪的状态管理与事件机制，减少全局副作用  
3. 保留/强化现有功能：禁手检测、四种对局模式、存档与回放、AI 元数据等  
4. 内建质量保障手段：单元测试、持续集成、文档对齐  

## 用户画像与使用场景

| 用户类型 | 需求 | 示例场景 |
|-----------|------|-----------|
| 新手玩家 | 简单 AI 对手、规则提示、友好的 UI | 手机上打开网页，短时间体验五子棋 |
| 普通玩家 | 平衡 AI、禁手规则学习、对局记录 | 与朋友对弈或挑战 AI，实时查看禁手信息 |
| 高手/研究者 | 高强度 AI、机机对战分析、回放复盘 | 观看高水平 AI 对决、导出棋谱做研究 |
| 开发者 | 清晰架构、可调试接口、模块化设计 | 二次开发 AI、扩展 UI、嵌入到其他平台 |
| 测试/运营 | 全面功能验证、指标监控、内容更新 | 使用测试面板验证功能、生成版本说明 |

## 术语定义

| 名称 | 定义 |
|------|------|
| **棋盘坐标** | 15×15 网格，以 (x, y) 表示，左上角为 (0,0)，右下为 (14,14) |
| **禁手** | 黑棋禁止落子的特殊情况：三三、四四、长连 |
| **PvP** | Player vs Player，双人本地对战模式 |
| **PvE** | Player vs Environment，人类 vs AI 模式 |
| **EvE** | Environment vs Environment，双 AI 自动对战模式 |
| **AI 难度** | BEGINNER / NORMAL / HARD / HELL 四档算法策略 |
| **棋谱** | 对局的完整落子序列与元数据 |
| **回放引擎** | 独立于实时对局的播放控制器，可暂停、快进、步进 |

## 功能需求

### 1. 对局模式
- **PvP 模式**：两位玩家轮流操作，支持悔棋、重新开始
- **PvE 模式**：玩家执黑或白（可配置），AI 执另一方，支持四级难度
- **EvE 模式**：黑白双方均由 AI 操控，难度独立配置，禁止玩家操作
- **扩展预留**：未来可插入 Online PvP、定时赛等模式，设计留接口

### 2. 游戏流程
1. 新游戏：重置棋盘、计时器、历史记录、提示信息  
2. 落子：校验位置信息 → 禁手检测 → 更新棋盘状态 → 切换当前玩家  
3. 胜负判定：检测横/竖/主对角/副对角方向是否五连  
4. 平局：225 步填满棋盘即视为平局  
5. 游戏结束：记录胜负信息、可保存棋谱、展示结果弹窗  
6. 悔棋：撤回最近一步（EvE 禁用）  
7. 提示：AI 给出建议落点（EvE 禁用；对 PvE、PvP 作为辅助）

### 3. 辅助功能
- **棋谱保存/加载**：JSON 格式、兼容旧版本数据结构（向前兼容）
- **棋局回放**：播放/暂停、单步前进/后退、倍速控制、关键事件跳转
- **AI 建议高亮**：Canvas 可视化建议点（圆圈+十字标记）
- **最后落子高亮**：黑棋金色光晕、白棋粉色光晕
- **禁手提醒**：禁手类型（长连/三三/四四）提示 + 高亮标记
- **模式指示**：UI 中显示当前模式、难度、回合、用时
- **统计数据**：基本对局统计（总步数、用时、胜方）

### 4. 配置项（需暴露 API）
- 棋盘大小（默认 15，保留扩展）
- 禁手检测开关、提示开关
- AI 难度、先手配置
- 提示信息展示时间、样式
- 模块元信息查询接口（`__moduleInfo`）

## 游戏规则与算法要求

### 1. 棋盘与坐标
- 棋盘为 15×15 格（可配置），Canvas 中留足 padding 显示坐标轴
- 天元（7,7）等关键点需特殊标记
- 鼠标/触摸坐标转换需考虑缩放与设备像素比

### 2. 胜负判定
- 四个方向：水平、垂直、主对角线、副对角线
- 需要返回胜利连线坐标数组，用于高亮展示

### 3. 禁手检测（仅黑棋）
- **三三禁手**：一步落子形成≥2 个活三
- **四四禁手**：一步落子形成≥2 个活四（或冲四）
- **长连禁手**：落子后在任一方向形成 ≥6 连
- 实现思路参考旧代码：
  - 临时模拟落子 → 通过线性签名 / 模式匹配统计活三活四
  - 返回禁手类型、方向、涉及的坐标列表，供 UI 展示

### 4. 棋型评估
- 需支持以下棋型检测：五连、活四、冲四、破四、活三、冲三、活二、眠二
- 组合棋型加分：双活四、活四+活三、双活三、双冲四等

### 5. 候选点生成
- 仅在已有棋子周围一定半径（如 2~3 格）内生成候选点
- 候选点按邻近棋子数、中心权重排序，提升搜索效率

## AI 系统需求

### 1. 难度级别（保持四档）
| 难度 | 算法 | 搜索深度 | 关键特性 | 目标体验 |
|------|------|----------|-----------|-----------|
| Beginner | 随机/基础评分 | 1-2 ply | 随机+简单防守 | 玩家轻松取胜 |
| Normal | Minimax + Alpha-Beta | 2-3 ply | 棋型评分、攻防平衡 | 旗鼓相当 |
| Hard | 高级搜索、威胁序列 | 3-4 ply | 开局库、VCT/VCF、候选点优选 | 对高手有压力 |
| Hell | Alpha-Beta + 威胁空间 + 可选 NN | 4-5 ply | 深层威胁分析、证明数搜索 | 接近专家水平 |

### 2. 核心要求
- 响应时间：Beginner < 600ms，Normal < 1000ms，Hard < 2000ms，Hell < 2400ms
- 提供 AI 思考状态通知（UI Loading 动画 + 文案）
- PvE 模式只使用一个难度选择，EvE 模式需要黑白各自配置
- `GameCore.getAIMove(player)` 根据当前执子方返回落点
- 暴露 AI 策略接口，便于未来引入外部引擎或 WebAssembly 模块

### 3. EvE 模式特殊逻辑
- 禁用悔棋、禁用提示、玩家点击棋盘显示提示信息
- 自动轮询 AI 落子，直到对局结束
- UI 显示“机机对战 (黑:困难 vs 白:地狱)”等难度组合
- 需要回放与存档兼容（自动对局仍生成完整棋谱）

## 系统架构与模块划分

### 1. 模块总览

```text
index.html            # 页面骨架、脚本引入顺序、模态框
css/                  # 样式（主样式 + 动画）
js/
  ├── core/           # 游戏核心层（拆分建议）
  │   ├── GameState.js          # 棋盘数据、当前玩家、历史记录
  │   ├── RuleEngine.js         # 胜负判定、禁手检测
  │   ├── AIEngine.js           # AI 总控与策略调度
  │   └── ModeManager.js        # PvP/PvE/EvE 切换、流程控制
  ├── ui/
  │   ├── CanvasRenderer.js     # Canvas 绘制、坐标转换、视觉特效
  │   ├── HudPanel.js           # 模式/回合/用时/提示等 UI 模块
  │   └── DialogManager.js      # 结束弹窗、设置弹窗
  ├── services/
  │   ├── SaveLoadService.js    # 本地存档、文件导入导出
  │   ├── ReplayService.js      # 回放控制器
  │   └── ModuleRegistry.js     # 模块元信息、依赖检测、事件广播
  ├── utils/
  │   ├── MathUtils.js          # 棋型分析、评分辅助
  │   ├── StorageUtils.js       # LocalStorage 包装
  │   └── EventBus.js           # 事件总线
  └── main.js                   # 项目入口，实例化各模块
```

> **说明**：旧项目的 `demo.js` 职责庞杂（UI + 逻辑混杂），建议在重写时拆分为若干 UI 组件 + 控制器。

### 2. 模块职责摘要

| 模块 | 主要职责 | 关键接口 |
|------|-----------|-----------|
| GameState | 棋盘矩阵、落子记录、当前玩家、模式状态、时间 | `reset()`, `applyMove()`, `undoMove()`, `getSnapshot()` |
| RuleEngine | 禁手检测、胜负判定、棋型分析 | `validateMove(move)`, `checkWin(move)`, `detectForbidden(move)` |
| AIEngine | 根据难度选择策略、生成最佳落子 | `setDifficulty(level, side)`, `computeMove(state)` |
| CanvasRenderer | 绘制棋盘、棋子、提示、特效 | `render(state)`, `highlightMove(move)`, `showForbidden(info)` |
| HudPanel | 更新模式、回合、计时、提示 | `updateStatus(state)`, `setHint(text, type)` |
| SaveLoadService | 存档/读档/导入导出 | `save(state)`, `load(snapshot)`, `exportJSON(snapshot)` |
| ReplayService | 控制棋谱播放 | `play(sequence)`, `pause()`, `stepForward()` |
| ModuleRegistry | 模块元数据、依赖检测、自定义事件 | `registerModule(info)`, `checkDependencies()`, `logModuleInfo()` |

### 3. 模块元信息规范
- 每个模块需暴露 `__moduleInfo`: `{ name, version, author, dependencies, optionalDependencies }`
- 注册时触发 `moduleLoaded` 事件，携带 `detail` 为元信息对象
- 提供 `ModuleDependencyChecker` 工具，用于外部测试页面或控制台诊断

## 数据与持久化需求

### 1. 棋谱数据结构（建议）
```json
{
  "version": "1.1.0",
  "mode": "PvE",
  "settings": {
    "firstPlayer": 1,
    "aiDifficulty": "HARD",
    "forbiddenRules": true
  },
  "moves": [
    { "step": 1, "player": 1, "x": 7, "y": 7, "timestamp": 1704354567123 },
    { "step": 2, "player": 2, "x": 7, "y": 8, "aiScore": 4200 }
  ],
  "result": {
    "winner": 2,
    "reason": "five_in_row",
    "winLine": [ {"x": 10, "y": 6}, ... ]
  },
  "metadata": {
    "duration": 523,
    "lastMove": {"x": 10, "y": 6},
    "aiProfile": {"black": "HARD", "white": "HELL"}
  }
}
```

### 2. 本地存储键规范
- `gomoku:lastGameState`
- `gomoku:settings`
- `gomoku:replayQueue`
- `gomoku:moduleInfoCache`

### 3. 回放信息
- 支持从存档或实时对局克隆数据，互不影响
- 回放状态机：`idle → loading → playing → paused → finished`
- 回放控制事件：`play`, `pause`, `step`, `seek`, `speedChange`

## 界面与交互规范

### 1. 布局结构
- 左侧信息面板：当前玩家、模式信息、计时、控制按钮
- 中央棋盘区：Canvas + 坐标标识 + 提示区域
- 底部回放控制器：进度条、步数、控制按钮（在回放模式下显示）
- 顶部工具栏：标题、版本号徽章、提示/设置/帮助按钮

### 2. UI 交互细则
- 点击棋盘空位时显示落子动画 + 音效（可选）
- 悬停时显示浅色预览圈（仅有效空位）
- 落子后高亮最后一步，持续到下一步落下
- AI 思考时禁用相关按钮，并在 HUD 中显示“黑方 AI 思考中…”
- 禁手时：Canvas 高亮 + HUD 文案 + 可选弹窗
- 设置面板：根据模式动态显示可配置项（PvE→单一 AI、EvE→双 AI）
- 响应式：在窄屏设备中，信息面板折叠成抽屉式

### 3. 视觉规范（旧项目参考，可保留调整）
- 棋盘木质背景色：`#f4e4bc`
- 黑棋颜色：`#2f2f2f`，白棋颜色：`#f0f0f0`
- 选中高亮：黑棋 `rgba(255, 215, 0, 0.6)`，白棋 `rgba(255, 105, 180, 0.6)`
- 禁手提示：`rgba(211, 47, 47, 0.85)` 边框 + 填充
- 提示文本颜色：根据类型（info/ warning/ error）切换

## 非功能需求

| 类别 | 指标 |
|------|------|
| **性能** | 落子响应 < 16ms；禁手检测 < 5ms；硬 AI 搜索 < 2.4s；60fps 渲染 |
| **兼容性** | 支持 Chrome 95+、Edge 95+、Safari 15+、Firefox 95+；移动端兼容主流浏览器 |
| **可用性** | 支持键盘导航（焦点在棋盘时可用方向键选择位置、Enter 落子）；文字可访问；提供帮助文档链接 |
| **可维护性** | 模块分层清晰、单元测试覆盖率 ≥70%、代码遵循 ESLint 规则、风格统一 |
| **可扩展性** | 支持通过配置启用/禁用特性；模块化导出便于二次开发 |
| **安全性** | 禁止 `eval` / 动态脚本；限制本地存储数据大小与错误处理；输入校验 |

## 日志、监控与可观测性

- 统一日志前缀：`[GameCore]`, `[Renderer]`, `[AI]`, `[Replay]`, `[SaveLoad]`
- 日志级别：debug / info / warn / error，需可通过配置调整
- AI 调试：提供 `window.GomokuDebug` 对象，支持打印状态、查看候选点
- 性能监控：封装计时器，记录关键算法耗时并在 dev 模式打印
- 模块加载事件：监听 `moduleLoaded`，用于模块诊断面板

## 开发流程与质量保障

### 1. 代码规范
- ES2020 语法；严格模式
- 命名风格：类名 PascalCase、方法 camelCase、常量 UPPER_SNAKE
- 每个公共方法提供 JSDoc 注释
- 禁止全局变量污染，统一通过模块导出或依赖注入

### 2. 测试策略
- **单元测试**：RuleEngine 检测、AI 候选生成、GameState 状态迁移
- **集成测试**：完整对局流程、不同模式切换、存档回放
- **UI 测试**：Canvas 渲染快照、关键控件可交互性
- **回归测试**：版本升级时对 v1.0.3 的关键功能做对比测试
- **性能基准**：AI 计算、渲染 100 次平均耗时

### 3. 工具链建议
- 构建：仍可保持原生（无打包），但建议引入 Vite/ESBuild 便于模块化开发
- Lint：ESLint + Prettier
- 测试：Vitest / Jest（配合 jsdom）；Canvas 使用 mocking / OffscreenCanvas
- CI：GitHub Actions 运行 lint + test（尽量不修改 CI 脚本，如需请征得同意）

## 技术债务与改进建议

| 旧项目问题 | 重写策略 |
|-------------|----------|
| `demo.js` 2000+ 行，承担 UI/逻辑/数据/事件 | 拆分为多个 UI 组件与控制器，使用事件总线通信 |
| 大量 `console.log`、缺乏调试开关 | 引入 Logger 工具，根据环境开关日志 |
| 模块导出兼容性依赖全局变量 | 统一通过 `ModuleRegistry` 管理，支持浏览器全局 + CommonJS |
| 禁手检测代码冗长难维护 | 抽象 `PatternAnalyzer`，配置化棋型模板 |
| 回放与实时共用状态，易互相影响 | 保持 GameState 不变，回放使用快照克隆 |
| 缺乏自动化测试 | 建立基础测试框架，沉淀核心算法测试用例 |

## 实施路线与任务拆解

### 阶段 0：准备（1 天）
1. 搭建新仓库结构（目录、基础依赖、Lint、测试框架）
2. 迁移文档体系（本说明书 + 其它关键文档）
3. 搭建示例页面骨架（基础 Canvas、UI 骨架）

### 阶段 1：核心引擎（4 天）
1. 实现 GameState & RuleEngine  
2. 封装禁手检测组件  
3. 构建 CanvasRenderer（仅棋盘 + 基础落子）  
4. 打通 PvP 流程（落子、判胜、悔棋）

### 阶段 2：AI 与模式控制（5 天）
1. 实现候选点生成、评分函数基础  
2. 实现四个 AI 难度策略  
3. 构建 ModeManager，完成 PvE 流程  
4. 实现 EvE 自动对战 + UI 禁用逻辑

### 阶段 3：存档回放与 UI 打磨（4 天）
1. SaveLoadService（本地存储 + 文件导出导入）  
2. ReplayService（播放控制、进度条、速度调节）  
3. UI 细节：提示信息、禁手高亮、最后落子效果  
4. 响应式布局与无障碍优化

### 阶段 4：质量与发布（3 天）
1. 补充测试用例、性能基准测试  
2. 模块元信息 & 依赖检查工具  
3. 文档与示例更新、CHANGELOG 撰写  
4. 版本验收与灰度发布

### 交付物
- 可运行的全新代码基线（v2.0.0 里程碑）
- 自动化测试报告、性能数据
- 更新后的文档集合、示例截图

## 附录

### A. 坐标系统
```
   A B C D E F G H I J K L M N O
 1 ┌─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┐
 2 ├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤
 ⋮
 8 ├─┼─┼─┼─┼─┼─┼─★─┼─┼─┼─┼─┼─┼─┤
 ⋮
15 └─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┘
```
> 推荐在 UI 中提供开关显示坐标轴

### B. 参考文档映射
- 旧项目 `docs/design/五子棋规则与算法.md` → 对应本说明书第 6、7 章
- `docs/design/AI难度等级设计.md` → 第 7 章 AI 策略
- `docs/reference/开发者快速参考.md` → 建议迁移到新的开发者指南
- `docs/guides/新项目开发指南.md` → 已吸收于本说明书

### C. 相关资源
- 现代五子棋 AI 算法参考：Victor Allis Threat-Space Search、Proof-Number Search
- Canvas 性能优化：使用离屏 Canvas、合并绘制操作
- 可选升级方向：WebAssembly AI、PWA 离线支持、在线匹配模式

---

> **备注**：本说明书已汇总旧项目的关键信息，并结合重构经验给出改进建议。后续所有规划、开发、测试均应以本文件为权威依据，必要时根据版本迭代更新。